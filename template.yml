AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Metadata:
  AWS::ServerlessRepo::Application:
    Name: tweet-sentiment-python
    Description: Python implementation of serverless app that publishes sentiment score metrics of tweets to CloudWatch Metrics.
    Author: James Hood
    SpdxLicenseId: MIT
    LicenseUrl: LICENSE
    ReadmeUrl: README.md
    Labels: [twitter, tweet, sentiment]
    HomePageUrl: https://github.com/jlhood/tweet-sentiment-python
    SemanticVersion: 0.0.4
    SourceCodeUrl: https://github.com/jlhood/tweet-sentiment-python/tree/0.0.4

Parameters:
  SearchText:
    Type: String
    Description: Search text to pass to Twitter. You can experiment with the Twitter search API at https://twitter.com/search-home
    # Search text is used as a CW Logs dimension so have to keep it within the constraints of a dimension value.
    MinLength: 1
    MaxLength: 255
  PollingFrequencyInMinutes:
    Type: Number
    Description: Frequency (in minutes) to poll for new tweets.
    MinValue: 1
    Default: 1
  LogLevel:
    Type: String
    Description: Log level for Lambda function logging, e.g., ERROR, INFO, DEBUG, etc
    Default: INFO

Resources:
  TweetSentiment:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: tweetsentiment.handler
      Runtime: python3.7
      Tracing: Active
      Timeout: 60
      Policies:
        - ComprehendBasicAccessPolicy: {}
        - CloudWatchPutMetricPolicy: {}
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          SEARCH_TEXT: !Ref SearchText

  Tweets:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:077246666028:applications/aws-serverless-twitter-event-source
        SemanticVersion: 2.0.0
      Parameters: 
        # Max number of tweets to send to the TweetProcessor lambda function on each invocation.
        BatchSize: '20' # max allowed by PutMetricData API
        # Non-URL-encoded search text poller should use when querying Twitter Search API.
        SearchText: !Sub '${SearchText} -filter:nativeretweets'
        # If true, the app will remember the last tweet found and only invoke the tweet processor function for newer tweets. If false, the app will be stateless and invoke the tweet processor function with all tweets found in each polling cycle.
        StreamModeEnabled: 'true'
        PollingFrequencyInMinutes: !Ref PollingFrequencyInMinutes
        # Name of lambda function that should be invoked to process tweets. Note, this must be a function name and not a function ARN.
        TweetProcessorFunctionName: !Ref TweetSentiment

  Dashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |
        {
            "widgets": [
                {
                    "type": "metric",
                    "x": 12,
                    "y": 6,
                    "width": 12,
                    "height": 6,
                    "properties": {
                        "metrics": [
                            [ "TweetSentiment", "SentimentScore", "SearchText", "${SearchText}", "SentimentType", "Mixed" ],
                            [ "...", { "stat": "Maximum" } ],
                            [ "...", { "stat": "Minimum" } ]
                        ],
                        "view": "timeSeries",
                        "stacked": false,
                        "region": "${AWS::Region}",
                        "stat": "Average",
                        "period": 300,
                        "title": "Mixed - ${SearchText}",
                        "yAxis": {
                            "left": {
                                "label": "%",
                                "showUnits": false,
                                "min": 0,
                                "max": 1
                            }
                        }
                    }
                },
                {
                    "type": "metric",
                    "x": 0,
                    "y": 0,
                    "width": 12,
                    "height": 6,
                    "properties": {
                        "metrics": [
                            [ "TweetSentiment", "SentimentScore", "SearchText", "${SearchText}", "SentimentType", "Positive" ],
                            [ "...", { "stat": "Maximum" } ],
                            [ "...", { "stat": "Minimum" } ]
                        ],
                        "view": "timeSeries",
                        "stacked": false,
                        "region": "${AWS::Region}",
                        "stat": "Average",
                        "period": 300,
                        "title": "Positive - ${SearchText}",
                        "yAxis": {
                            "left": {
                                "label": "%",
                                "showUnits": false,
                                "min": 0,
                                "max": 1
                            }
                        }
                    }
                },
                {
                    "type": "metric",
                    "x": 12,
                    "y": 0,
                    "width": 12,
                    "height": 6,
                    "properties": {
                        "metrics": [
                            [ "TweetSentiment", "SentimentScore", "SearchText", "${SearchText}", "SentimentType", "Negative" ],
                            [ "...", { "stat": "Maximum" } ],
                            [ "...", { "stat": "Minimum" } ]
                        ],
                        "view": "timeSeries",
                        "stacked": false,
                        "region": "${AWS::Region}",
                        "stat": "Average",
                        "period": 300,
                        "title": "Negative - ${SearchText}",
                        "yAxis": {
                            "left": {
                                "label": "%",
                                "showUnits": false,
                                "min": 0,
                                "max": 1
                            }
                        }
                    }
                },
                {
                    "type": "metric",
                    "x": 0,
                    "y": 6,
                    "width": 12,
                    "height": 6,
                    "properties": {
                        "metrics": [
                            [ "TweetSentiment", "SentimentScore", "SearchText", "${SearchText}", "SentimentType", "Neutral" ],
                            [ "...", { "stat": "Maximum" } ],
                            [ "...", { "stat": "Minimum" } ]
                        ],
                        "view": "timeSeries",
                        "stacked": false,
                        "region": "${AWS::Region}",
                        "stat": "Average",
                        "period": 300,
                        "title": "Neutral - ${SearchText}",
                        "yAxis": {
                            "left": {
                                "label": "%",
                                "showUnits": false,
                                "min": 0,
                                "max": 1
                            }
                        }
                    }
                }
            ]
        }